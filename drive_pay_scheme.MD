# [Домой](./README.MD)

# Описание схемы `drive_pay`
Схема управляет данными, связанными с платежными операциями. Она включает таблицы для хранения информации о мерчантах и заказах, материализованные представления для сервисов и последовательности для генерации уникальных идентификаторов мерчантов и заказов. Функции в этой схеме обеспечивают создание заказов, обновление их статусов и обработку информации о заказах.


## Типы

### `status_order`
Перечисление состояний заказа
| Значение   | Описание              |
|------------|-----------------------|
| new        | Новый                 |
| prepare    | Готовится             |
| expect     | Ожидает               |
| close      | Закрыт                |

## Таблицы

### `merch_scheme`
Содержит данные мерчантов
| Название поля | Тип данных | Описание поля                          |
|---------------|------------|----------------------------------------|
| idmerch       | int2       | Уникальный идентификатор мерчанта      |
| accesuaries   | jsonb      | Дополнительные данные в формате JSON   |
| login         | varchar(50)| Логин мерчанта                         |
| notification  | jsonb      | Уведомления в формате JSON             |

### `order`
Содержит данные заказов
| Название поля  | Тип данных         | Описание поля                       |
|----------------|--------------------|-------------------------------------|
| id_order       | int8               | Уникальный идентификатор заказа     |
| param          | jsonb              | Параметры заказа в формате JSON     |
| id_paybank     | int4               | Идентификатор платежа               |
| enable         | `status_order`     | Статус заказа                       |

### *`mv_service`
**Материализованное представление** для данных сервиса
| Название поля   | Тип данных         | Описание поля                       |
|-----------------|--------------------|-------------------------------------|
| id_service      | int4               | Уникальный идентификатор сервиса    |
| service_name    | varchar(255)       | Название сервиса                    |


## Последовательности

### `merch_sch_idmerch_seq`
Последовательность для генерации уникальных идентификаторов мерчантов
**От 1 До 32000**, База **1**

### `order_id_paybank_seq`
Последовательность для генерации уникальных идентификаторов платежей
**От 1 До 2147483647**, База **1**

### `order_idorder_seq`
Последовательность для генерации уникальных идентификаторов заказов
**От 1 До 32000**, База **1**


## Функции

### `drive_pay.f_mvservice()`
Триггер для обновления материализованного представления `drive_pay.mv_service`.
1. Обновляет данные в материализованном представлении `drive_pay.mv_service`.

### `drive_pay.f_order(x_json json)`
Функция для создания заказа.
1. Извлекает текущую метку времени.
2. Вставляет новый заказ в таблицу `drive_pay.order`.
3. Извлекает логин, URL для обратного вызова, телефон и email клиента из таблицы `drive_pay.merch_scheme`.
4. Обновляет параметры заказа дополнительными данными.
5. Возвращает метку времени заказа.

### `drive_pay.f_order_id(id text)`
Функция для получения данных заказа по идентификатору.
1. Извлекает идентификатор заказа по идентификатору расчета.
2. Извлекает URL фискального чека.
3. Формирует и возвращает JSON с данными заказа.

### `drive_pay.f_order_status()`
Триггер для обновления статуса заказа.
1. Извлекает идентификатор платежа.
2. Обновляет статус заказа в таблице `ataxi_transfer.order`.

### `drive_pay.f_order_status_test()`
Тестовая функция для обновления статуса заказа.
1. Извлекает идентификатор платежа.
2. Обновляет статус заказа в таблице `ataxi_transfer.order`.
3. Возвращает JSON с данными заказа.