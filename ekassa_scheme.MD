# [Домой](./README.MD)

# Описание схемы `ekassa`
Схема управляет данными и операциями, связанными с эквайрингом. Она включает таблицы для хранения настроек эквайринговой системы и проверки транзакций, а также их партиционированные версии по годам. Функции в этой схеме обрабатывают данные транзакций, генерируют запросы к эквайринговой системе и обрабатывают ответы.

## Таблицы

### `ekassa`
Содержит основные настройки эквайринговой системы
| Название поля     | Тип данных  | Описание поля                          |
|-------------------|-------------|----------------------------------------|
| id_kass           | int4        | Уникальный идентификатор кассы         |
| json_settings     | jsonb       | Настройки кассы в формате JSON         |
| org               | varchar(12) | Организация                            |
| provider          | varchar(50) | Провайдер                               |
| channel_notify    | varchar(20) | Канал для уведомлений                  |

### `ekassa_check`
Содержит данные проверок эквайринговой системы
| Название поля     | Тип данных  | Описание поля                          |
|-------------------|-------------|----------------------------------------|
| id_ekassa         | int4        | Уникальный идентификатор проверки      |
| query_check       | jsonb       | Запрос на проверку в формате JSON      |
| ans_ekassa        | jsonb       | Ответ эквайринговой системы            |
| call_back         | jsonb       | Обратный вызов в формате JSON          |
| year              | int2        | Год проведения проверки                |
| data_check        | jsonb       | Данные проверки в формате JSON         |
| qtranz_payment    | int8        | Идентификатор платежа                  |
| query_check2      | varchar     | Дополнительный запрос на проверку      |

### `ekassa_<N>`
Содержит данные проверок за <N>-ый год (допустим `ekassa_2024`). Это тот же самый ekassa_check, только для конкретного года
| Название поля     | Тип данных  | Описание поля                          |
|-------------------|-------------|----------------------------------------|
| id_ekassa         | int4        | Уникальный идентификатор проверки      |
| query_check       | jsonb       | Запрос на проверку в формате JSON      |
| ans_ekassa        | jsonb       | Ответ эквайринговой системы            |
| call_back         | jsonb       | Обратный вызов в формате JSON          |
| year              | int2        | Год проведения проверки                |
| data_check        | jsonb       | Данные проверки в формате JSON         |
| qtranz_payment    | int8        | Идентификатор платежа                  |
| query_check2      | varchar     | Дополнительный запрос на проверку      |

## Последовательности

### `ekassa_id_ekassa_seq`
Последовательность для генерации уникальных идентификаторов касс и проверок

По сути есть для каждого года такие последовательности

Диапазон: **1 - 2147483647**; База: **1**

## Функции

### `ekassa.f_ansclient(param json, ans_client character)` - Функция обновляет ответ клиента по транзакции.
1. Извлекает год и идентификатор транзакции из параметра `param`.
2. Ищет ответ по году и идентификатору транзакции в таблице `reports.payment`.
3. Объединяет найденный ответ с дополнительной информацией `ans_client`.
4. Обновляет ответ в таблице `reports.payment`.

### `ekassa.f_array(xarray character varying)` - Функция на языке Python, возвращающая первый элемент массива.
1. Преобразует строку `xarray` в массив.
2. Возвращает первый элемент массива.

### `ekassa.f_businessru_callback(x_json_clbk json)` - Функция обрабатывает обратный вызов Business.ru.
1. Извлекает идентификатор транзакции и URL чека из параметра `x_json_clbk`.
2. Очищает URL чека от экранирующих символов.
3. Ищет URL обратного вызова и год в таблице `reports.payment`.
4. Ищет идентификатор заказа в таблице `ekassa.ekassa_check`.
5. Обновляет таблицу `ekassa.ekassa_check` обратным вызовом.
6. Возвращает JSON с информацией об обратном вызове.

### `ekassa.f_check_businessru(xid integer)` - Функция проверяет транзакцию в Business.ru.
1. Генерирует случайное значение `nonce`.
2. Извлекает данные транзакции из таблицы `reports.payment`.
3. Строит JSON-запрос для проверки.
4. Генерирует хэш запроса.
5. Возвращает сформированный запрос.

### `ekassa.f_check_businessru_old(xid integer)` - Функция проверяет транзакцию в Business.ru (старая версия).
1. Генерирует случайное значение `nonce`.
2. Извлекает данные транзакции из таблицы `reports.payment`.
3. Строит JSON-запрос для проверки.
4. Генерирует хэш запроса.
5. Возвращает сформированный запрос.

### `ekassa.f_check_businessru_test(xid integer)` - Тестовая функция для проверки транзакции в Business.ru.
1. Генерирует случайное значение `nonce`.
2. Извлекает данные транзакции из таблицы `reports.payment`.
3. Строит JSON-запрос для проверки.
4. Генерирует хэш запроса.
5. Возвращает сформированный запрос.

### `ekassa.f_ekassa_business_cron()` - Функция для выполнения cron-задач эквайринга.
1. Возвращает идентификаторы транзакций, которые не были обработаны более 60 секунд.

### `ekassa.f_ekassa_businessru_answer(xjson json, xid bigint)` - Функция обновляет ответ эквайринговой системы.
1. Обновляет таблицу `ekassa.ekassa_check` ответом `xjson` по идентификатору транзакции `xid`.

### `ekassa.f_ekassa_businessru_count_err()` - Функция возвращает количество ошибок эквайринговой системы.
1. Считает количество не обработанных транзакций в таблице `reports.payment`.

### `ekassa.f_ekassa_businessru_getcheck(OUT xdata json)` - Функция возвращает данные для проверки эквайринговой системы.
1. Возвращает данные из таблицы `doc_ekassa_businessru` со статусом `new`.

### `ekassa.f_ekassa_businessru_jdata(xjson json, xxid integer, xtoken json)` - Функция формирует данные для проверки эквайринговой системы.
1. Извлекает данные из JSON-параметров `xjson` и `xtoken`.
2. Строит JSON-запрос для проверки.
3. Возвращает сформированный запрос.

### `ekassa.f_ekassa_businessru_put_token(x_json json)` - Функция обновляет токен в эквайринговой системе.
1. Извлекает токен из JSON-параметра `x_json`.
2. Обновляет настройки эквайринговой системы новым токеном.
3. Возвращает обновленные настройки.

### `ekassa.f_ekassa_businessru_sign_token()` - Функция генерирует токен для эквайринговой системы.
1. Генерирует случайное значение `nonce`.
2. Извлекает настройки эквайринговой системы.
3. Строит JSON-запрос для получения токена.
4. Генерирует хэш запроса.
5. Возвращает сформированный запрос.

### `ekassa.f_pt_json(xjson character, xparam character)` - Функция на языке Python, сортирующая JSON и добавляющая параметры.
1. Преобразует строку `xjson` в JSON.
2. Сортирует элементы JSON.
3. Добавляет параметры `xparam`.
4. Возвращает сформированный запрос.

### `ekassa.f_sort_json(xjson json, xsecret character)` - Функция на языке Python, сортирующая JSON и добавляющая секретный ключ.
1. Преобразует строку `xjson` в JSON.
2. Сортирует элементы JSON.
3. Добавляет секретный ключ `xsecret`.
4. Генерирует хэш запроса.
5. Возвращает сформированный запрос.

### `ekassa.f_sort_json_copy(xjson json, xsecret character)` - Копия функции `f_sort_json` на языке Python.
1. Преобразует строку `xjson` в JSON.
2. Сортирует элементы JSON.
3. Добавляет секретный ключ `xsecret`.
4. Генерирует хэш запроса.
5. Возвращает сформированный запрос.

### `ekassa.f_test(xid integer)` - Тестовая функция для проверки транзакции в эквайринговой системе.
1. Генерирует случайное значение `nonce`.
2. Извлекает данные транзакции из таблицы `reports.payment`.
3. Строит JSON-запрос для проверки.
4. Генерирует хэш запроса.
5. Возвращает сформированный запрос.