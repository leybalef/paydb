# [Домой](./README.MD)

# Описание схемы `2can`
Схема управляет информацией о платежах и мерчантах, включая хранение данных о мерчантах и платежах. Она содержит таблицы для данных с поддержкой различных типов данных и ограничений, а также функции для обработки информации о платежах.

## Таблицы

### `merchant_tap2go`
Содержит данные о мерчантах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| idmerch          | int2         | Уникальный идентификатор мерчанта  |
| accesuaries      | jsonb        | Аксессуары                         |
| mid              | varchar(50)  | Идентификатор мерчанта             |
| syspay_merch     | int4         | Система оплаты мерчанта            |

### `syspay`
Содержит данные о платежах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id               | int4         | Уникальный идентификатор платежа   |
| json_inside      | jsonb        | Внутренние данные платежа          |

## Последовательности

### `merch_idmerch_seq`
Последовательность для генерации уникальных идентификаторов мерчантов
- От 1 до 32000, кэш есть, зацикливания нет.

### `syspay_id_paybank_seq`
Последовательность для генерации уникальных идентификаторов платежей
- От 1 до 2147483647, кэш есть, зацикливания нет.

## Функции

### `2can.f_syspay(json)`
Функция для обработки платежа
1. Вставляет данные платежа в таблицу `syspay`.
2. Возвращает JSON с сообщением "ok".

### `2can.f_tr_payment()`
Функция для обработки транзакций
1. Извлекает данные платежа из таблицы `syspay`.
2. Извлекает и обрабатывает различные параметры, включая привилегии, тарифы и суммы.
3. Обновляет данные платежа и вставляет их в соответствующие таблицы для отчетности.
#### Подробнее:
1. Извлекает данные платежа из таблицы syspay по идентификатору платежа (например, id = 767).
2. Извлекает различные параметры из JSON данных платежа, такие как MID, Amount, PaidAt, и описание платежа.
3. Определяет привилегии мерчанта по MID.
4. Извлекает данные о тарифах и других параметрах из связанных таблиц (например, common.firmservice, common.commparam, auth.users).
5. Обновляет JSON данные платежа с новыми параметрами, включая идентификатор платежа (id_paybank).
6. Рассчитывает сумму платежа с учетом коэффициентов (например, xsum = (xamount::numeric * xratio::numeric)::numeric(10,2)).
7. Вставка данных в отчетные таблицы:
8. Вставляет данные платежа в таблицу отчетности (например, reports.payment).
9. Генерирует уведомление с идентификатором транзакции.
10. Возвращает JSON данные с обновленной информацией о платеже.
