
# [Домой](./README.MD)

# Описание схемы `ataxi_transfer`
Схема управляет информацией о трансферах в системе, включая хранение данных о расчетах, ценах, регионах и заказах. Она содержит таблицы для данных с поддержкой различных типов данных и ограничений, а также функции для обработки информации о трансферах.


## Таблицы

### `!location`
Содержит данные о местоположениях
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id               | int4         | Уникальный идентификатор           |
| region           | varchar(50)  | Регион                             |
| town             | _text        | Город                              |
| location         | json         | Местоположение                     |

### `calc_sec`
Содержит данные о расчетах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id_calc          | varchar      | Уникальный идентификатор расчета   |
| year             | int2         | Год расчета                        |
| data_calc        | jsonb        | Данные расчета                     |
| id_order         | int4         | Идентификатор заказа               |
| counter          | int4         | Счетчик                            |
Комментарий: Таблица с партиционированием по диапазону `year`

### `merch_scheme`
Содержит данные о схемах товаров
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| idmerch          | int2         | Уникальный идентификатор товара    |
| accesuaries      | jsonb        | Аксессуары                         |
| login            | varchar(50)  | Логин                              |
| notification     | jsonb        | Уведомления                        |

### `order`
Содержит данные о заказах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id_order         | int8         | Уникальный идентификатор заказа    |
| param            | jsonb        | Параметры заказа                   |
| id_calc          | varchar(50)  | Идентификатор расчета              |
| enable           | bool         | Статус активации                   |
| id_paybank       | int4         | Идентификатор банка оплаты         |

### `price`
Содержит данные о ценах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id_price         | int2         | Уникальный идентификатор цены      |
| town             | int2         | Идентификатор города               |
| view_trans       | int2         | Идентификатор типа трансфера       |
| tarif            | int2         | Идентификатор тарифа               |
| amount           | numeric(10,2)| Сумма                              |

### `region`
Содержит данные о регионах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id_region        | int2         | Уникальный идентификатор региона   |
| name_region      | varchar(50)  | Название региона                   |
| alias            | varchar(10)  | Псевдоним                          |

### `tarif`
Содержит данные о тарифах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id_tarif         | int2         | Уникальный идентификатор тарифа    |
| name_tarif       | varchar(50)  | Название тарифа                    |
| view_trans       | int2         | Идентификатор типа трансфера       |

### `town`
Содержит данные о городах
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id_town          | int2         | Уникальный идентификатор города    |
| name_town        | varchar(150) | Название города                    |
| region           | int2         | Регион                             |
| short_name       | varchar(10)  | Краткое название                   |
| fld_sort         | int4         | Поле сортировки                    |

### `view_transfer`
Содержит данные о видах трансферов
| Название поля    | Тип данных   | Описание поля                      |
|------------------|--------------|------------------------------------|
| id_view          | int2         | Уникальный идентификатор вида      |
| view_name        | varchar(25)  | Название вида                      |

## Последовательности

### `calc_counter_seq`
Последовательность для генерации уникальных идентификаторов расчетов
- От 1 до 2147483647, кэш есть, зацикливания нет.

### `merch_sch_idmerch_seq`
Последовательность для генерации уникальных идентификаторов товаров
- От 1 до 32000, кэш есть, зацикливания нет.

### `order_id_paybank_seq`
Последовательность для генерации уникальных идентификаторов банков оплаты
- От 1 до 2147483647, кэш есть, зацикливания нет.

### `order_idorder_seq`
Последовательность для генерации уникальных идентификаторов заказов
- От 1 до 32000, кэш есть, зацикливания нет.

### `price_idprice_seq`
Последовательность для генерации уникальных идентификаторов цен
- От 1 до 32000, кэш есть, зацикливания нет.

### `region_idregion_seq`
Последовательность для генерации уникальных идентификаторов регионов
- От 1 до 32000, кэш есть, зацикливания нет.

### `tarif_idtarif_seq`
Последовательность для генерации уникальных идентификаторов тарифов
- От 1 до 32000, кэш есть, зацикливания нет.

### `town_idtown_seq`
Последовательность для генерации уникальных идентификаторов городов
- От 1 до 32000, кэш есть, зацикливания нет.

### `view_idview_seq`
Последовательность для генерации уникальных идентификаторов видов трансферов
- От 1 до 32000, кэш есть, зацикливания нет.

## Функции

### `ataxi_transfer.f_calc(json)`
Функция для расчета
1. Извлекает значение идентификатора расчета из входного параметра `id_calc`.
2. Извлекает значение года из входного параметра `timestamp`.
3. Ищет цену для каждого трансфера в таблице `price`.
4. Рассчитывает итоговую сумму для всех трансферов.
5. Вставляет данные расчета в таблицу `calc_sec`.
6. Возвращает рассчитанную сумму или ошибку, если идентификатор заказа уже существует.

### `ataxi_transfer.f_order(json)`
Функция для обработки заказа
1. Извлекает значение идентификатора расчета из входного параметра `id_calc`.
2. Извлекает значение логина и суммы из входного параметра `json`.
3. Вставляет заказ в таблицу `order` и возвращает идентификатор заказа.
4. Если заказ уже существует, возвращает данные заказа.
5. Обновляет таблицу `calc_sec` с идентификатором заказа.
6. Возвращает ответ о статусе заказа.

### `ataxi_transfer.f_order_id(text)`
Функция для получения данных о заказе по его идентификатору
1. Извлекает значение идентификатора заказа из входного параметра `id`.
2. Ищет данные заказа в таблице `order`.
3. Если найден чек, возвращает данные заказа с ссылкой на чек.
4. Возвращает данные заказа.

### `ataxi_transfer.f_order_status()`
Триггер для обновления статуса заказа
1. Ищет данные оплаты в таблице `syspay`.
2. Если оплата подтверждена, обновляет статус заказа на активный.
3. Возвращает обновленные данные.

### `ataxi_transfer.insert_town_trigger()`
Триггер для обработки вставки города
1. Отправляет уведомление с данными нового города.
2. Возвращает null.

### `ataxi_transfer.update_town_trigger()`
Триггер для обработки обновления города
1. Отправляет уведомление с данными обновленного города.
2. Возвращает null.
